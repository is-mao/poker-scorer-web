<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä»Šæ™šè°è¯·å®¢ - ç‰Œå±€è®¡åˆ†ï¼ˆç¦»çº¿ç‰ˆï¼‰</title>
  <style>
    :root {
      --primary: #10b981;
      --primary-dark: #059669;
      --primary-light: #d1fae5;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      min-height: 100vh;
      color: var(--gray-800);
    }
    .page { min-height: 100vh; display: flex; flex-direction: column; }
    .nav-bar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
    }
    .container { flex: 1; max-width: 1000px; margin: 0 auto; padding: 20px; width: 100%; }
    .room-selector { margin-bottom: 20px; }
    .selector-row { display: flex; gap: 12px; align-items: center; }
    .room-select {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius);
      font-size: 15px;
      background: #fff;
      cursor: pointer;
    }
    .room-select:focus { outline: none; border-color: var(--primary); }
    .selector-btns { display: flex; gap: 10px; }
    .btn-icon {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: var(--radius);
      background: #fff;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    .btn-icon:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .empty-icon { font-size: 72px; margin-bottom: 20px; }
    .empty-text { color: var(--gray-500); font-size: 16px; }
    .room-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .room-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 500;
    }
    .badge.round { background: #e0e7ff; color: #4338ca; }
    .room-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn-sm {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: all 0.2s;
    }
    .btn-sm:hover { background: var(--gray-50); transform: translateY(-1px); }
    .btn-sm.danger { color: var(--danger); }
    .btn-sm.danger:hover { background: #fee2e2; }
    .players-panel {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--gray-100);
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-700);
      cursor: pointer;
    }
    .total-score { font-size: 14px; color: var(--primary); font-weight: 600; }
    .total-score strong { font-size: 16px; }
    .toggle-icon { color: var(--gray-400); font-size: 12px; }
    .players-list { margin-bottom: 12px; }
    .player-row {
      display: flex;
      align-items: center;
      padding: 14px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 4px;
    }
    .player-row:hover { background: var(--gray-50); }
    .player-row.dealer { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .player-row.dealer:hover { background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%); }
    .dealer-tag {
      font-size: 11px;
      background: #f59e0b;
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
    }
    .player-rank {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
      margin-right: 12px;
    }
    .player-rank.rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; }
    .player-rank.rank-2 { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #fff; }
    .player-rank.rank-3 { background: linear-gradient(135deg, #f97316, #ea580c); color: #fff; }
    .player-avatar { font-size: 22px; margin-right: 12px; cursor: pointer; transition: transform 0.2s; }
    .player-avatar:hover { transform: scale(1.2); }
    .player-name { flex: 1; font-size: 16px; font-weight: 500; }
    .player-score { font-size: 22px; font-weight: 700; }
    .player-score.positive { color: var(--primary); }
    .player-score.negative { color: var(--danger); }
    .add-player-btn {
      text-align: center;
      padding: 14px;
      color: var(--primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: 2px dashed var(--gray-300);
      border-radius: 10px;
      transition: all 0.2s;
    }
    .add-player-btn:hover { border-color: var(--primary); background: var(--primary-light); }
    .action-bar { display: flex; gap: 16px; margin-bottom: 20px; }
    .btn-action {
      flex: 1;
      padding: 16px;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-action.outline {
      background: #fff;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-action.outline:hover { background: var(--primary-light); }
    .btn-action.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
    }
    .btn-action.primary:hover { box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4); transform: translateY(-1px); }
    .records-panel {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .records-list { margin-top: 14px; overflow-x: auto; }
    .records-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      min-width: 300px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }
    .records-table th, .records-table td { padding: 14px 12px; text-align: center; }
    .records-table th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      font-weight: 600;
      color: #fff;
      font-size: 13px;
    }
    .records-table tbody tr { transition: background 0.2s; }
    .records-table tbody tr:nth-child(even) { background: var(--gray-50); }
    .records-table tbody tr:hover { background: var(--primary-light); }
    .records-table td { border-bottom: 1px solid var(--gray-100); }
    .records-table tbody tr:last-child td { border-bottom: none; }
    .records-table .round-num { color: var(--gray-500); font-size: 13px; font-weight: 500; white-space: nowrap; }
    .records-table .positive { color: var(--primary); font-weight: 600; }
    .records-table .negative { color: var(--danger); font-weight: 600; }
    .records-table tfoot tr { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .records-table tfoot td { font-weight: 700; border-top: 2px solid var(--warning); padding: 16px 12px; }
    .records-table tfoot .round-num { color: #b45309; font-weight: 700; }
    .records-table .total-cell { font-size: 16px; }
    .empty-records { text-align: center; padding: 32px; color: var(--gray-400); font-size: 14px; background: var(--gray-50); border-radius: 10px; }

    /* å¼¹çª— */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(2px);
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: #fff;
      border-radius: var(--radius);
      padding: 28px;
      width: 100%;
      max-width: 400px;
      animation: modalIn 0.2s ease;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-title { font-size: 20px; font-weight: 600; text-align: center; margin-bottom: 10px; }
    .modal-desc { font-size: 14px; color: var(--gray-500); text-align: center; margin-bottom: 20px; }
    .highlight-dealer { color: #b45309; font-weight: 600; background: #fef3c7; padding: 2px 10px; border-radius: 4px; }
    .modal-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
    }
    .modal-input:focus { border-color: var(--primary); }
    .modal-textarea {
      width: 100%;
      height: 100px;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      resize: none;
      font-family: inherit;
    }
    .modal-textarea:focus { border-color: var(--primary); }
    .modal-btns { display: flex; gap: 12px; }
    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .modal-btn.cancel { background: var(--gray-100); color: var(--gray-600); }
    .modal-btn.cancel:hover { background: var(--gray-200); }
    .modal-btn.confirm { background: var(--primary); color: #fff; }
    .modal-btn.confirm:hover { background: var(--primary-dark); }
    .score-inputs { max-height: 220px; overflow-y: auto; margin-bottom: 16px; }
    .score-row { display: flex; align-items: center; margin-bottom: 12px; }
    .score-name { width: 90px; font-size: 15px; font-weight: 500; }
    .score-row input {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 15px;
      outline: none;
    }
    .score-row input:focus { border-color: var(--primary); }
    .avg-section { margin-bottom: 20px; }
    .avg-label { font-size: 13px; color: var(--gray-500); margin-bottom: 8px; text-align: center; }
    .avg-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      text-align: center;
    }
    .avg-input:focus { border-color: var(--primary); }
    .player-actions { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .player-action-btn {
      padding: 16px;
      background: var(--gray-50);
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .player-action-btn:hover { background: var(--gray-100); }
    .player-action-btn.danger { color: var(--danger); }
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 15px;
      z-index: 2000;
      animation: toastIn 0.2s ease;
    }
    @keyframes toastIn { from { opacity: 0; } to { opacity: 1; } }
    .draw-modal {
      background: #fff;
      border-radius: var(--radius);
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .draw-header {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 17px;
      font-weight: 600;
    }
    .draw-close { font-size: 26px; cursor: pointer; opacity: 0.8; }
    .draw-close:hover { opacity: 1; }
    .draw-stage { padding: 20px; min-height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gray-50); }
    .draw-input {
      width: 100%;
      height: 80px;
      padding: 14px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      resize: none;
      outline: none;
      font-family: inherit;
    }
    .draw-input:focus { border-color: #f59e0b; }
    .wheel-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 10px auto;
    }
    .wheel-svg {
      width: 100%;
      height: 100%;
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));
    }
    .wheel-pointer-container {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    .wheel-center-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, #ffffff, #e6e6e6);
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 2px 4px rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 10;
      border: 3px solid #f59e0b;
    }
    .draw-result { 
      margin-top: 16px; 
      font-size: 18px; 
      color: var(--gray-800); 
      font-weight: 600; 
      text-align: center;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding: 12px 20px;
      border-radius: 10px;
    }
    .draw-result strong { color: #d97706; }
    .draw-btn {
      display: block;
      width: calc(100% - 40px);
      margin: 15px auto 20px;
      padding: 16px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    .draw-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(245, 158, 11, 0.5); }
    .draw-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .settle-modal { max-width: 420px; }
    .settle-header { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 20px; color: var(--gray-800); }
    .settle-list { margin-bottom: 24px; }
    .settle-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: var(--gray-50);
    }
    .settle-item.top-1 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
    .settle-item.top-2 { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
    .settle-item.top-3 { background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%); }
    .settle-rank { width: 36px; font-size: 20px; text-align: center; }
    .settle-name { flex: 1; font-size: 16px; font-weight: 500; }
    .settle-score { font-size: 18px; font-weight: 700; }
    .settle-score.positive { color: var(--primary); }
    .settle-score.negative { color: var(--danger); }
    .confirm-modal { text-align: center; }
    .confirm-icon { font-size: 56px; margin-bottom: 16px; }
    .confirm-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--gray-800); }
    .confirm-desc { font-size: 14px; color: var(--gray-500); line-height: 1.6; margin-bottom: 24px; }
    .confirm-desc strong { color: var(--gray-700); }
    .confirm-modal.danger .confirm-title { color: var(--danger); }
    .modal-btn.confirm.danger { background: var(--danger); }
    .modal-btn.confirm.danger:hover { background: #dc2626; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
const App = {
  currentRoom: null,
  rooms: [],
  userInfo: { nickname: 'ç©å®¶' },
  selectedPlayer: null,
  
  init() {
    this.loadData();
    this.render();
  },
  
  loadData() {
    this.rooms = JSON.parse(localStorage.getItem('poker_rooms') || '[]');
    this.userInfo = JSON.parse(localStorage.getItem('poker_user') || '{"nickname":"ç©å®¶"}');
    if (this.rooms.length > 0) {
      this.currentRoom = this.rooms[0];
    }
  },
  
  saveData() {
    localStorage.setItem('poker_rooms', JSON.stringify(this.rooms));
    localStorage.setItem('poker_user', JSON.stringify(this.userInfo));
  },
  
  render() {
    document.getElementById('app').innerHTML = this.renderPage();
    this.bindEvents();
  },
  
  renderPage() {
    return `
      <div class="page active">
        <div class="nav-bar">
          <span>ğŸ´ ä»Šæ™šè°è¯·å®¢ï¼ˆç¦»çº¿ç‰ˆï¼‰</span>
        </div>
        <div class="container">
          ${this.renderRoomSelector()}
          ${this.currentRoom ? this.renderRoomContent() : this.renderEmptyState()}
        </div>
        ${this.renderModals()}
      </div>
    `;
  },
  
  renderRoomSelector() {
    const roomOptions = this.rooms.map(r => 
      `<option value="${r.id}" ${this.currentRoom && this.currentRoom.id === r.id ? 'selected' : ''}>
        æˆ¿é—´ ${r.id} (${r.players.length}äºº)
      </option>`
    ).join('');
    
    return `
      <div class="room-selector">
        <div class="selector-row">
          <select id="room-select" class="room-select">
            <option value="">-- é€‰æ‹©æˆ¿é—´ --</option>
            ${roomOptions}
          </select>
          <div class="selector-btns">
            <button class="btn-icon" id="btn-create" title="åˆ›å»ºæˆ¿é—´">â•</button>
            <button class="btn-icon" id="btn-draw" title="æŠ½ç­¾">ğŸ¯</button>
          </div>
        </div>
      </div>
    `;
  },
  
  renderEmptyState() {
    return `
      <div class="empty-state">
        <div class="empty-icon">ğŸ´</div>
        <div class="empty-text">ç‚¹å‡» â• åˆ›å»ºæˆ¿é—´å¼€å§‹è®°åˆ†</div>
      </div>
    `;
  },
  
  renderRoomContent() {
    const room = this.currentRoom;
    const sorted = [...room.players].sort((a, b) => b.score - a.score);
    const totalPositive = room.players.reduce((sum, p) => sum + (p.score > 0 ? p.score : 0), 0);
    
    return `
      <div class="room-content">
        <div class="room-header">
          <div class="room-title">
            æˆ¿é—´ ${room.id} 
            <span class="badge round">ç¬¬${room.rounds.length + 1}å±€</span>
          </div>
          <div class="room-actions">
            <button class="btn-sm" id="btn-settle">ğŸ“Š ç»“ç®—</button>
            <button class="btn-sm" id="btn-reset">ğŸ”„ é‡ç½®</button>
            <button class="btn-sm danger" id="btn-delete">âŒ è§£æ•£</button>
          </div>
        </div>
        
        <div class="players-panel">
          <div class="panel-header">
            <span>ç©å®¶æ’å</span>
            <span class="total-score">æ€»æµæ°´: <strong>${totalPositive}</strong> åˆ†</span>
          </div>
          <div class="players-list">
            ${sorted.map((p, i) => this.renderPlayerRow(p, i)).join('')}
          </div>
          <div class="add-player-btn" id="add-player-inline">+ æ·»åŠ ç©å®¶</div>
        </div>
        
        <div class="action-bar">
          <button class="btn-action outline" id="btn-give">æ‰¹é‡ç»™åˆ†</button>
          <button class="btn-action primary" id="btn-receive">æ‰¹é‡å¾—åˆ†</button>
        </div>
        
        <div class="records-panel">
          <div class="panel-header" id="toggle-records">
            <span>æ”¶æ”¯è®°å½• (${room.rounds.length}å±€)</span>
            <span class="toggle-icon">â–²</span>
          </div>
          <div class="records-list" id="records-list">
            ${this.renderRecords()}
          </div>
        </div>
      </div>
    `;
  },
  
  renderPlayerRow(player, index) {
    const rankClass = index < 3 ? `rank-${index + 1}` : '';
    const isDealer = player.isOwner;
    return `
      <div class="player-row ${isDealer ? 'dealer' : ''}" data-id="${player.id}">
        <div class="player-rank ${rankClass}">${index + 1}</div>
        <div class="player-avatar" data-player-id="${player.id}">${player.isOwner ? 'ğŸ‘‘' : 'ğŸ§‘'}</div>
        <div class="player-name">${player.name}${isDealer ? ' <span class="dealer-tag">åº„</span>' : ''}</div>
        <div class="player-score ${player.score >= 0 ? 'positive' : 'negative'}">
          ${player.score >= 0 ? '+' : ''}${player.score}
        </div>
      </div>
    `;
  },
  
  renderRecords() {
    if (!this.currentRoom || !this.currentRoom.rounds.length) {
      return '<div class="empty-records">æš‚æ— è®°å½•</div>';
    }
    const players = this.currentRoom.players;
    const rounds = this.currentRoom.rounds;
    const headerCells = players.map(p => `<th>${p.name}</th>`).join('');
    const rows = rounds.map((r, i) => {
      const cells = players.map(p => {
        const record = r.scores.find(s => s.name === p.name);
        const change = record ? record.change : 0;
        const cls = change > 0 ? 'positive' : (change < 0 ? 'negative' : '');
        return `<td class="${cls}">${change !== 0 ? (change > 0 ? '+' : '') + change : '-'}</td>`;
      }).join('');
      return `<tr><td class="round-num">ç¬¬${i + 1}å±€</td>${cells}</tr>`;
    }).join('');
    const totalCells = players.map(p => {
      const cls = p.score > 0 ? 'positive' : (p.score < 0 ? 'negative' : '');
      return `<td class="total-cell ${cls}">${p.score > 0 ? '+' : ''}${p.score}</td>`;
    }).join('');
    
    return `
      <table class="records-table">
        <thead><tr><th>å±€æ•°</th>${headerCells}</tr></thead>
        <tbody>${rows}</tbody>
        <tfoot><tr><td class="round-num">åˆè®¡</td>${totalCells}</tr></tfoot>
      </table>
    `;
  },

  renderModals() {
    const dealerPlayer = this.currentRoom ? (this.currentRoom.players.find(p => p.isOwner) || this.currentRoom.players[0]) : null;
    const others = this.currentRoom ? this.currentRoom.players.filter(p => !p.isOwner) : [];
    const dealerName = dealerPlayer ? `<span class="highlight-dealer">${dealerPlayer.name}</span>` : 'åº„å®¶';
    const inputsHTML = others.map(p => `
      <div class="score-row">
        <span class="score-name">${p.name}</span>
        <input class="score-input" data-id="${p.id}" type="number" placeholder="0">
      </div>
    `).join('');
    
    return `
      <div class="modal-overlay" id="modal-create">
        <div class="modal-content">
          <div class="modal-title">åˆ›å»ºæˆ¿é—´</div>
          <div class="modal-desc">è¾“å…¥ç©å®¶åç§°ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆç¬¬ä¸€ä¸ªä¸ºåº„å®¶ï¼‰</div>
          <textarea class="modal-textarea" id="input-players" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰,æå››,ç‹äº”,èµµå…­"></textarea>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-create">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-create">åˆ›å»º</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-add-player">
        <div class="modal-content">
          <div class="modal-title">æ·»åŠ ç©å®¶</div>
          <input class="modal-input" id="input-player-name" placeholder="ç©å®¶åç§°">
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-add-player">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-add-player">æ·»åŠ </button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-give">
        <div class="modal-content">
          <div class="modal-title">æ‰¹é‡ç»™åˆ†</div>
          <div class="modal-desc">ç»™å…¶ä»–ç©å®¶çš„åˆ†æ•°ä¼šä» ${dealerName} æ‰£é™¤</div>
          <div class="score-inputs">${inputsHTML}</div>
          <div class="avg-section">
            <div class="avg-label">æˆ–å‡æ‘Šæ€»åˆ†</div>
            <input class="avg-input" id="input-give-avg" type="number" placeholder="è¾“å…¥æ€»åˆ†ï¼Œè‡ªåŠ¨å¹³å‡åˆ†é…">
          </div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-give">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-give">ç¡®è®¤</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-receive">
        <div class="modal-content">
          <div class="modal-title">æ‰¹é‡å¾—åˆ†</div>
          <div class="modal-desc">ä»å…¶ä»–ç©å®¶æ”¶å–çš„åˆ†æ•°ä¼šåŠ åˆ° ${dealerName}</div>
          <div class="score-inputs">${inputsHTML.replace(/score-input/g, 'receive-input')}</div>
          <div class="avg-section">
            <div class="avg-label">æˆ–å‡æ‘Šæ€»åˆ†</div>
            <input class="avg-input" id="input-receive-avg" type="number" placeholder="è¾“å…¥æ€»åˆ†ï¼Œè‡ªåŠ¨å¹³å‡åˆ†é…">
          </div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-receive">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-receive">ç¡®è®¤</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-player">
        <div class="modal-content">
          <div class="modal-title" id="player-modal-title">ç©å®¶æ“ä½œ</div>
          <div class="player-actions">
            <button class="player-action-btn" id="player-pay">ğŸ’° æ”¯ä»˜åˆ†æ•°</button>
            <button class="player-action-btn" id="player-rename">âœï¸ ä¿®æ”¹åç§°</button>
            <button class="player-action-btn" id="player-dealer">ğŸ‘‘ è®¾ä¸ºåº„å®¶</button>
            <button class="player-action-btn danger" id="player-kick">âŒ è¸¢å‡ºç©å®¶</button>
          </div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-player">å…³é—­</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-pay">
        <div class="modal-content">
          <div class="modal-title">æ”¯ä»˜åˆ†æ•°</div>
          <div class="modal-desc" id="pay-desc">æ”¯ä»˜ç»™ç©å®¶</div>
          <input class="modal-input" id="input-pay" type="number" placeholder="è¾“å…¥åˆ†æ•°">
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-pay">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-pay">ç¡®å®š</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-rename">
        <div class="modal-content">
          <div class="modal-title">ä¿®æ”¹åç§°</div>
          <input class="modal-input" id="input-rename" placeholder="æ–°åç§°">
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-rename">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-rename">ç¡®å®š</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-settle">
        <div class="modal-content settle-modal">
          <div class="settle-header">ğŸ† ç»“ç®—æ’å</div>
          <div class="settle-list" id="settle-list"></div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-settle">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-settle">ç¡®è®¤ç»“ç®—</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-reset">
        <div class="modal-content confirm-modal">
          <div class="confirm-icon">ğŸ”„</div>
          <div class="confirm-title">é‡ç½®åˆ†æ•°</div>
          <div class="confirm-desc">ç¡®å®šè¦å°†æ‰€æœ‰ç©å®¶çš„åˆ†æ•°é‡ç½®ä¸º 0 å—ï¼Ÿ</div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-reset">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="confirm-reset">ç¡®è®¤é‡ç½®</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-delete">
        <div class="modal-content confirm-modal danger">
          <div class="confirm-icon">âš ï¸</div>
          <div class="confirm-title">è§£æ•£æˆ¿é—´</div>
          <div class="confirm-desc">ç¡®å®šè¦è§£æ•£æˆ¿é—´ <strong>${this.currentRoom ? this.currentRoom.id : ''}</strong> å—ï¼Ÿ</div>
          <div class="modal-btns">
            <button class="modal-btn cancel" data-close="modal-delete">å–æ¶ˆ</button>
            <button class="modal-btn confirm danger" id="confirm-delete">ç¡®è®¤è§£æ•£</button>
          </div>
        </div>
      </div>
      
      <div class="modal-overlay" id="modal-draw">
        <div class="draw-modal">
          <div class="draw-header">
            <span class="draw-close" data-close="modal-draw">Ã—</span>
            <span>ç©å®¶æŠ½ç­¾</span>
            <span style="width:24px"></span>
          </div>
          <div class="draw-stage" id="draw-stage">
            <textarea class="draw-input" id="draw-input" placeholder="è¾“å…¥ç©å®¶åç§°ï¼Œç”¨é€—å·åˆ†éš”"></textarea>
          </div>
          <button class="draw-btn" id="btn-start-draw">ğŸ¯ å¼€å§‹æŠ½ç­¾</button>
        </div>
      </div>
    `;
  },

  bindEvents() {
    document.getElementById('room-select')?.addEventListener('change', (e) => {
      const id = e.target.value;
      this.currentRoom = this.rooms.find(r => r.id === id) || null;
      this.render();
    });
    document.getElementById('btn-create')?.addEventListener('click', () => this.showModal('modal-create'));
    document.getElementById('confirm-create')?.addEventListener('click', () => this.createRoom());
    document.getElementById('btn-draw')?.addEventListener('click', () => this.showDrawModal());
    document.getElementById('btn-start-draw')?.addEventListener('click', () => this.startDraw());
    document.getElementById('add-player-inline')?.addEventListener('click', () => this.showModal('modal-add-player'));
    document.getElementById('confirm-add-player')?.addEventListener('click', () => this.addPlayer());
    document.getElementById('btn-settle')?.addEventListener('click', () => this.settleRoom());
    document.getElementById('confirm-settle')?.addEventListener('click', () => this.confirmSettle());
    document.getElementById('btn-reset')?.addEventListener('click', () => this.showModal('modal-reset'));
    document.getElementById('confirm-reset')?.addEventListener('click', () => this.confirmReset());
    document.getElementById('btn-delete')?.addEventListener('click', () => this.showModal('modal-delete'));
    document.getElementById('confirm-delete')?.addEventListener('click', () => this.confirmDelete());
    document.getElementById('btn-give')?.addEventListener('click', () => this.showModal('modal-give'));
    document.getElementById('btn-receive')?.addEventListener('click', () => this.showModal('modal-receive'));
    document.getElementById('confirm-give')?.addEventListener('click', () => this.confirmGive());
    document.getElementById('confirm-receive')?.addEventListener('click', () => this.confirmReceive());
    
    document.querySelectorAll('.player-row').forEach(el => {
      el.addEventListener('click', (e) => {
        if (e.target.classList.contains('player-avatar')) return;
        const id = el.dataset.id;
        this.selectedPlayer = this.currentRoom.players.find(p => p.id === id);
        document.getElementById('player-modal-title').textContent = this.selectedPlayer.name;
        this.showModal('modal-player');
      });
    });
    
    document.querySelectorAll('.player-avatar').forEach(el => {
      el.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        const playerId = el.dataset.playerId;
        const player = this.currentRoom.players.find(p => p.id === playerId);
        if (player && !player.isOwner) {
          this.currentRoom.players.forEach(p => p.isOwner = (p.id === playerId));
          this.saveData();
          this.render();
          this.toast(`${player.name} å·²è®¾ä¸ºåº„å®¶`);
        }
      });
    });
    
    document.getElementById('player-pay')?.addEventListener('click', () => this.showPayModal());
    document.getElementById('player-rename')?.addEventListener('click', () => this.showRenameModal());
    document.getElementById('player-dealer')?.addEventListener('click', () => this.setAsDealer());
    document.getElementById('player-kick')?.addEventListener('click', () => this.kickPlayer());
    document.getElementById('confirm-pay')?.addEventListener('click', () => this.confirmPay());
    document.getElementById('confirm-rename')?.addEventListener('click', () => this.confirmRename());
    
    document.getElementById('toggle-records')?.addEventListener('click', () => {
      const list = document.getElementById('records-list');
      const icon = document.querySelector('.toggle-icon');
      if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.textContent = 'â–²';
      } else {
        list.style.display = 'none';
        icon.textContent = 'â–¼';
      }
    });
    
    document.querySelectorAll('[data-close]').forEach(el => {
      el.addEventListener('click', () => this.closeModal(el.dataset.close));
    });
    document.querySelectorAll('.modal-overlay').forEach(el => {
      el.addEventListener('click', (e) => {
        if (e.target === el) el.classList.remove('show');
      });
    });
  },
  
  showModal(id) { document.getElementById(id)?.classList.add('show'); },
  closeModal(id) { document.getElementById(id)?.classList.remove('show'); },
  toast(msg) {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2000);
  },

  createRoom() {
    const input = document.getElementById('input-players').value.trim();
    const names = input.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);
    if (names.length < 2) { this.toast('è‡³å°‘éœ€è¦2åç©å®¶'); return; }
    if (names.length > 10) { this.toast('æœ€å¤š10åç©å®¶'); return; }
    const uniqueNames = new Set(names);
    if (uniqueNames.size !== names.length) { this.toast('ç©å®¶åç§°ä¸èƒ½é‡å¤'); return; }
    
    const id = Math.floor(100000 + Math.random() * 900000).toString();
    const players = names.map((name, i) => ({
      id: Date.now().toString() + i,
      name,
      score: 0,
      isOwner: i === 0
    }));
    const room = { id, players, rounds: [], createTime: new Date().toLocaleString(), settled: false };
    this.rooms.unshift(room);
    this.currentRoom = room;
    this.saveData();
    this.closeModal('modal-create');
    this.render();
    this.toast('æˆ¿é—´åˆ›å»ºæˆåŠŸ');
  },
  
  addPlayer() {
    const name = document.getElementById('input-player-name').value.trim();
    if (!name) { this.toast('è¯·è¾“å…¥åç§°'); return; }
    if (this.currentRoom.players.some(p => p.name === name)) { this.toast('åç§°å·²å­˜åœ¨'); return; }
    this.currentRoom.players.push({ id: Date.now().toString(), name, score: 0, isOwner: false });
    this.saveData();
    this.closeModal('modal-add-player');
    this.render();
    this.toast('æ·»åŠ æˆåŠŸ');
  },

  confirmGive() {
    const dealer = this.currentRoom.players.find(p => p.isOwner) || this.currentRoom.players[0];
    const avgTotal = parseInt(document.getElementById('input-give-avg').value) || 0;
    const inputs = document.querySelectorAll('.score-input');
    const count = inputs.length;
    
    if (avgTotal > 0) {
      if (avgTotal % count !== 0) {
        this.toast(`æ€»åˆ† ${avgTotal} æ— æ³•è¢« ${count} äººæ•´é™¤`);
        return;
      }
      const per = avgTotal / count;
      const scores = [];
      this.currentRoom.players.filter(p => !p.isOwner).forEach(p => {
        p.score += per;
        scores.push({ name: p.name, change: per });
      });
      dealer.score -= avgTotal;
      scores.push({ name: dealer.name, change: -avgTotal });
      this.currentRoom.rounds.push({ scores, time: new Date().toLocaleString() });
      this.saveData();
      this.closeModal('modal-give');
      this.render();
      this.toast(`æ¯äºº +${per}ï¼Œè®°å½•æˆåŠŸ`);
      return;
    }
    
    const scores = [];
    let total = 0;
    inputs.forEach(input => {
      const id = input.dataset.id;
      const change = parseInt(input.value) || 0;
      if (change !== 0) {
        const player = this.currentRoom.players.find(p => p.id === id);
        if (player) {
          player.score += change;
          total += change;
          scores.push({ name: player.name, change });
        }
      }
    });
    if (total !== 0) {
      dealer.score -= total;
      scores.push({ name: dealer.name, change: -total });
      this.currentRoom.rounds.push({ scores, time: new Date().toLocaleString() });
      this.saveData();
      this.toast('è®°å½•æˆåŠŸ');
    } else {
      this.toast('è¯·è¾“å…¥åˆ†æ•°');
      return;
    }
    this.closeModal('modal-give');
    this.render();
  },
  
  confirmReceive() {
    const dealer = this.currentRoom.players.find(p => p.isOwner) || this.currentRoom.players[0];
    const avgTotal = parseInt(document.getElementById('input-receive-avg').value) || 0;
    const inputs = document.querySelectorAll('.receive-input');
    const count = inputs.length;
    
    if (avgTotal > 0) {
      if (avgTotal % count !== 0) {
        this.toast(`æ€»åˆ† ${avgTotal} æ— æ³•è¢« ${count} äººæ•´é™¤`);
        return;
      }
      const per = avgTotal / count;
      const scores = [];
      this.currentRoom.players.filter(p => !p.isOwner).forEach(p => {
        p.score -= per;
        scores.push({ name: p.name, change: -per });
      });
      dealer.score += avgTotal;
      scores.push({ name: dealer.name, change: avgTotal });
      this.currentRoom.rounds.push({ scores, time: new Date().toLocaleString() });
      this.saveData();
      this.closeModal('modal-receive');
      this.render();
      this.toast(`æ¯äºº -${per}ï¼Œè®°å½•æˆåŠŸ`);
      return;
    }
    
    const scores = [];
    let total = 0;
    inputs.forEach(input => {
      const id = input.dataset.id;
      const change = parseInt(input.value) || 0;
      if (change !== 0) {
        const player = this.currentRoom.players.find(p => p.id === id);
        if (player) {
          player.score -= change;
          total += change;
          scores.push({ name: player.name, change: -change });
        }
      }
    });
    if (total !== 0) {
      dealer.score += total;
      scores.push({ name: dealer.name, change: total });
      this.currentRoom.rounds.push({ scores, time: new Date().toLocaleString() });
      this.saveData();
      this.toast('è®°å½•æˆåŠŸ');
    } else {
      this.toast('è¯·è¾“å…¥åˆ†æ•°');
      return;
    }
    this.closeModal('modal-receive');
    this.render();
  },
  
  showPayModal() {
    this.closeModal('modal-player');
    document.getElementById('pay-desc').textContent = `æ”¯ä»˜ç»™ ${this.selectedPlayer.name}`;
    document.getElementById('input-pay').value = '';
    this.showModal('modal-pay');
  },
  
  confirmPay() {
    const score = parseInt(document.getElementById('input-pay').value) || 0;
    if (score === 0) { this.toast('è¯·è¾“å…¥åˆ†æ•°'); return; }
    const dealer = this.currentRoom.players.find(p => p.isOwner) || this.currentRoom.players[0];
    this.selectedPlayer.score += score;
    dealer.score -= score;
    this.currentRoom.rounds.push({
      scores: [
        { name: this.selectedPlayer.name, change: score },
        { name: dealer.name, change: -score }
      ],
      time: new Date().toLocaleString()
    });
    this.saveData();
    this.closeModal('modal-pay');
    this.render();
    this.toast('æ“ä½œæˆåŠŸ');
  },
  
  showRenameModal() {
    this.closeModal('modal-player');
    document.getElementById('input-rename').value = this.selectedPlayer.name;
    this.showModal('modal-rename');
  },
  
  confirmRename() {
    const name = document.getElementById('input-rename').value.trim();
    if (!name) { this.toast('è¯·è¾“å…¥åç§°'); return; }
    if (this.currentRoom.players.some(p => p.id !== this.selectedPlayer.id && p.name === name)) {
      this.toast('åç§°å·²å­˜åœ¨'); return;
    }
    this.selectedPlayer.name = name;
    this.saveData();
    this.closeModal('modal-rename');
    this.render();
    this.toast('ä¿®æ”¹æˆåŠŸ');
  },
  
  setAsDealer() {
    this.closeModal('modal-player');
    this.currentRoom.players.forEach(p => p.isOwner = (p.id === this.selectedPlayer.id));
    this.saveData();
    this.render();
    this.toast('å·²è®¾ä¸ºåº„å®¶');
  },
  
  kickPlayer() {
    this.closeModal('modal-player');
    if (this.selectedPlayer.isOwner) { this.toast('åº„å®¶ä¸å¯è¸¢å‡º'); return; }
    if (confirm(`ç¡®å®šè¸¢å‡º ${this.selectedPlayer.name}ï¼Ÿ`)) {
      this.currentRoom.players = this.currentRoom.players.filter(p => p.id !== this.selectedPlayer.id);
      this.saveData();
      this.render();
      this.toast('å·²è¸¢å‡º');
    }
  },
  
  settleRoom() {
    const sorted = [...this.currentRoom.players].sort((a, b) => b.score - a.score);
    const listHTML = sorted.map((p, i) => {
      let medal = '';
      if (i === 0) medal = 'ğŸ¥‡';
      else if (i === 1) medal = 'ğŸ¥ˆ';
      else if (i === 2) medal = 'ğŸ¥‰';
      const scoreClass = p.score > 0 ? 'positive' : (p.score < 0 ? 'negative' : '');
      return `
        <div class="settle-item ${i < 3 ? 'top-' + (i + 1) : ''}">
          <span class="settle-rank">${medal || (i + 1)}</span>
          <span class="settle-name">${p.name}</span>
          <span class="settle-score ${scoreClass}">${p.score > 0 ? '+' : ''}${p.score}</span>
        </div>
      `;
    }).join('');
    document.getElementById('settle-list').innerHTML = listHTML;
    this.showModal('modal-settle');
  },
  
  confirmSettle() {
    this.currentRoom.players.forEach(p => p.score = 0);
    this.currentRoom.rounds = [];
    this.currentRoom.settled = false;
    this.saveData();
    this.closeModal('modal-settle');
    this.render();
    this.toast('å·²ç»“ç®—ï¼Œå¼€å§‹æ–°ä¸€è½®');
  },
  
  confirmReset() {
    this.currentRoom.players.forEach(p => p.score = 0);
    this.saveData();
    this.closeModal('modal-reset');
    this.render();
    this.toast('å·²é‡ç½®');
  },
  
  confirmDelete() {
    this.rooms = this.rooms.filter(r => r.id !== this.currentRoom.id);
    this.currentRoom = this.rooms[0] || null;
    this.saveData();
    this.closeModal('modal-delete');
    this.render();
    this.toast('å·²è§£æ•£');
  },
  
  showDrawModal() {
    if (this.currentRoom && this.currentRoom.players.length >= 2) {
      document.getElementById('draw-input').value = this.currentRoom.players.map(p => p.name).join(',');
    }
    this.showModal('modal-draw');
  },
  
  wheelColors: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'],
  
  createWheel(names) {
    const count = names.length;
    const anglePerSegment = 360 / count;
    const radius = 140;
    const centerX = 150;
    const centerY = 150;
    
    let segments = '';
    let texts = '';
    
    names.forEach((name, i) => {
      const startAngle = (i * anglePerSegment - 90) * Math.PI / 180;
      const endAngle = ((i + 1) * anglePerSegment - 90) * Math.PI / 180;
      
      const x1 = centerX + radius * Math.cos(startAngle);
      const y1 = centerY + radius * Math.sin(startAngle);
      const x2 = centerX + radius * Math.cos(endAngle);
      const y2 = centerY + radius * Math.sin(endAngle);
      
      const largeArc = anglePerSegment > 180 ? 1 : 0;
      const color = this.wheelColors[i % this.wheelColors.length];
      
      segments += `<path d="M${centerX},${centerY} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z" fill="${color}" stroke="#fff" stroke-width="2"/>`;
      
      const textAngle = ((i + 0.5) * anglePerSegment - 90) * Math.PI / 180;
      const textRadius = radius * 0.65;
      const textX = centerX + textRadius * Math.cos(textAngle);
      const textY = centerY + textRadius * Math.sin(textAngle);
      const textRotation = (i + 0.5) * anglePerSegment;
      
      const displayName = name.length > 4 ? name.substring(0, 4) + '..' : name;
      
      texts += `<text x="${textX}" y="${textY}" text-anchor="middle" dominant-baseline="middle" transform="rotate(${textRotation}, ${textX}, ${textY})" fill="#fff" font-size="14" font-weight="600" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${displayName}</text>`;
    });
    
    const outerRing = `<circle cx="${centerX}" cy="${centerY}" r="${radius + 5}" fill="none" stroke="#d97706" stroke-width="8"/>`;
    
    return `
      <div class="wheel-container">
        <div class="wheel-pointer-container">
          <svg width="30" height="30" viewBox="0 0 30 30">
            <polygon points="15,30 0,0 30,0" fill="#dc2626"/>
            <polygon points="15,26 4,4 26,4" fill="#ef4444"/>
          </svg>
        </div>
        <svg class="wheel-svg" id="wheel" viewBox="0 0 300 300">
          ${outerRing}
          ${segments}
          ${texts}
        </svg>
        <div class="wheel-center-btn">ğŸ¯</div>
      </div>
    `;
  },
  
  drawNames: [], // ä¿å­˜æŠ½ç­¾ç©å®¶åˆ—è¡¨
  
  startDraw() {
    // å¦‚æœæœ‰è¾“å…¥æ¡†ï¼Œè¯»å–å¹¶ä¿å­˜ï¼›å¦åˆ™ç”¨ä¹‹å‰ä¿å­˜çš„
    const inputEl = document.getElementById('draw-input');
    if (inputEl) {
      const input = inputEl.value.trim();
      this.drawNames = input.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);
    }
    const names = this.drawNames;
    
    if (names.length < 2) { this.toast('è‡³å°‘éœ€è¦2äºº'); return; }
    if (names.length > 8) { this.toast('æœ€å¤šæ”¯æŒ8äºº'); return; }
    
    const stage = document.getElementById('draw-stage');
    const btn = document.getElementById('btn-start-draw');
    
    // éšæœºé€‰ä¸­
    const winnerIndex = Math.floor(Math.random() * names.length);
    const winner = names[winnerIndex];
    
    // è®¡ç®—è§’åº¦
    // è½¬ç›˜åˆå§‹çŠ¶æ€ï¼šç¬¬0ä¸ªæ‰‡å½¢ä»é¡¶éƒ¨å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ’åˆ—
    // æ¯ä¸ªæ‰‡å½¢å  anglePerSegment åº¦
    // ç¬¬ i ä¸ªæ‰‡å½¢çš„ä¸­å¿ƒä½ç½®åœ¨ (i * anglePerSegment + anglePerSegment/2) åº¦
    // è¦è®©ç¬¬ winnerIndex ä¸ªæ‰‡å½¢çš„ä¸­å¿ƒå¯¹å‡†é¡¶éƒ¨æŒ‡é’ˆï¼ˆ0åº¦ä½ç½®ï¼‰
    // éœ€è¦é€†æ—¶é’ˆæ—‹è½¬ï¼ˆè´Ÿè§’åº¦ï¼‰æˆ–é¡ºæ—¶é’ˆæ—‹è½¬ 360 - ç›®æ ‡è§’åº¦
    const count = names.length;
    const anglePerSegment = 360 / count;
    const baseRotation = 360 * 6; // è½¬6åœˆ
    // ç›®æ ‡æ‰‡å½¢ä¸­å¿ƒçš„åˆå§‹è§’åº¦
    const targetCenter = winnerIndex * anglePerSegment + anglePerSegment / 2;
    // éœ€è¦é¡ºæ—¶é’ˆæ—‹è½¬çš„è§’åº¦ï¼Œè®©ç›®æ ‡ä¸­å¿ƒåˆ°è¾¾é¡¶éƒ¨ï¼ˆ0åº¦ï¼‰
    const stopAngle = baseRotation + (360 - targetCenter);
    
    // å®Œå…¨é‡å»ºè½¬ç›˜å’Œç»“æœåŒºåŸŸ
    stage.innerHTML = this.createWheel(names) + '<div id="draw-result-area"></div>';
    btn.disabled = true;
    btn.textContent = 'ğŸ¯ è½¬åŠ¨ä¸­...';
    
    const wheel = document.getElementById('wheel');
    
    // å¼ºåˆ¶ä»0åº¦å¼€å§‹
    wheel.style.transition = 'none';
    wheel.style.transform = 'rotate(0deg)';
    
    // ä½¿ç”¨ setTimeout ç¡®ä¿é‡ç»˜
    setTimeout(() => {
      wheel.style.transition = 'transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)';
      wheel.style.transform = `rotate(${stopAngle}deg)`;
    }, 20);
    
    const self = this;
    setTimeout(() => {
      const resultArea = document.getElementById('draw-result-area');
      if (resultArea) {
        resultArea.innerHTML = `<div class="draw-result">ğŸ‰ æ­å–œ <strong>${winner}</strong> è¢«æŠ½ä¸­ï¼</div>`;
      }
      btn.disabled = false;
      btn.textContent = 'ğŸ¯ å†æ¥ä¸€æ¬¡';
      btn.onclick = function() { self.startDraw(); };
    }, 4500);
  }
};

document.addEventListener('DOMContentLoaded', () => App.init());
  </script>
</body>
</html>
